name: add_build_to_release

on:
  release:
    types: [ "created" ]

env:
  BUILD_PROJECT: "SpaceShooter2"
  PUBLISH_ARCHITECTURES: "linux-x64 win-x64"
  PRODUCED_FILES: ""

jobs:
  add_build_to_release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 6.0.x

    - name: restore dependencies
      run: dotnet restore ${{env.BUILD_PROJECT}}

    - name: publish and compress architectures
      run: |
        produced_files=""
        [ ! -d "${{github.workspace}}/builds" ] && mkdir "${{github.workspace}}/builds"
        for arch in ${{env.PUBLISH_ARCHITECTURES}}; do
            echo "processing architecture '$arch'"
            dotnet publish ${{env.BUILD_PROJECT}} -c Release --self-contained -r "$arch"

            fname="${{github.workspace}}/builds/$arch_${{env.BUILD_PROJECT}}.zip"
            produced_files="$fname $produced_files"

            cd "${{env.BUILD_PROJECT}}/bin/Release/net6.0/$arch"
            zip $fname *
            cd -
            echo "created $fname"
        done
        echo "created files: $produced_files"
        echo "PRODUCED_FILES=$produced_files" >> ${{github.env}}

    - name: upload release assets
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{github.event.release.tag_name}}
        files: "${{env.PRODUCED_FILES}}"
      env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

